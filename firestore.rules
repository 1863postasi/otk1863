rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- YARDIMCI FONKSİYONLAR ---
    
    // Kullanıcı giriş yapmış mı?
    function isSignedIn() {
      return request.auth != null;
    }
    
    // İşlemi yapan kişi, değiştirmek istediği kişiyle aynı mı?
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Kullanıcının verisini çek (Sadece giriş yapılmışsa çalışır)
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Admin kontrolü (Daha güvenli hale getirildi)
    function isAdmin() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserData().role == "admin";
    }

    // Kulüp Yetkilisi Kontrolü (Mevcut mantık korundu)
    function isClubOfficial(clubId) {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             ("clubRoles" in getUserData()) &&
             (clubId in getUserData().clubRoles) && 
             (getUserData().clubRoles[clubId] == "official");
    }

    // --- KOLEKSİYON KURALLARI ---

    // 0. BOUNDLE OYUN GÜVENLİĞİ


    // 1. KULLANICILAR (users)
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      

      allow delete: if isAdmin();


      // Oyun Geçmişi: Sadece kendi geçmişini okuyabilir.
      match /boundle/{document=**} {
        allow read, write: if isSignedIn() && isOwner(userId);
      }
    }

    // 2. KULÜPLER (clubs)
    match /clubs/{clubId} {
      allow read: if true;
      allow write: if isAdmin() || isClubOfficial(clubId);
    }

    // 3. ETKİNLİKLER (events)
    match /events/{eventId} {
      allow read: if true;
      allow create: if isAdmin() || (isSignedIn() && isClubOfficial(request.resource.data.clubId));
      allow update, delete: if isAdmin() || isClubOfficial(resource.data.clubId);
    }

    // 4. FORUM (Dersler, Hocalar, Yorumlar)
    
    // Dersler
    match /courses/{courseId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['instructorIds', 'rating', 'reviewCount', 'avgDifficulty'])
      );
    }

    // Hocalar
    match /instructors/{instructorId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['courseCodes', 'rating', 'reviewCount'])
      );
    }

    // Yorumlar
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // 5. KAYIP EŞYA (lost-items)
    match /lost-items/{itemId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAdmin() || (isSignedIn() && resource.data.ownerId == request.auth.uid);
      allow delete: if isAdmin() || (isSignedIn() && resource.data.ownerId == request.auth.uid);
    }

    // 6. PAZAR YERİ (listings)
    match /listings/{listingId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isAdmin() || (isSignedIn() && resource.data.sellerId == request.auth.uid);
      allow delete: if isAdmin() || (isSignedIn() && resource.data.sellerId == request.auth.uid);
    }

    // 7. MESAJLAR / NOTLAR (messages)
    match /messages/{messageId} {
      allow read: if isSignedIn() && (resource.data.toId == request.auth.uid || resource.data.fromId == request.auth.uid || isAdmin());
      allow create: if isSignedIn() && request.resource.data.fromId == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    // 8. GERİ BİLDİRİMLER (feedback)
    match /feedback/{feedbackId} {
      allow create: if true; 
      allow read, update, delete: if isAdmin();
    }

    // 9. DİĞER HER ŞEY (Genel Korumalar)
    match /{collectionName}/{document=**} {
      allow read: if true;
      allow write: if isAdmin(); 
    }
  }
}
